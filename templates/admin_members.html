{% extends "base.html" %}
{% block title %}회원관리 - 커뮤니티{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4">회원관리</h1>

  <div class="mb-3">
    <a href="/" class="btn btn-outline-secondary">← 목록으로</a>
  </div>

  <div class="table-wrap">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>번호</th>
          <th>아이디</th>
          <th>가입일</th>
          <th>블랙리스트</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="membersBody"></tbody>
    </table>
  </div>
</div>

<script>
  function escapeHtml(s) {
    if (s == null) return "";
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function loadMembers() {
    fetch("/api/admin/members", { credentials: "include" })
      .then(r => r.json().then(j => ({ ok: r.ok, json: j })))
      .then(({ ok, json }) => {
        const tbody = document.getElementById("membersBody");
        if (ok && json.members) {
          tbody.innerHTML = json.members.map(m => {
            const blBadge = m.is_blacklisted
              ? '<span class="badge bg-danger">블랙</span>'
              : '<span class="badge bg-secondary">정상</span>';
            const blBtn = m.is_blacklisted
              ? '<button class="btn btn-sm btn-outline-success btn-unblock" data-id="' + m.id + '">해제</button>'
              : '<button class="btn btn-sm btn-outline-danger btn-block" data-id="' + m.id + '">지정</button>';
            return "<tr><td>" + m.number + "</td><td>" + escapeHtml(m.username) + "</td><td>" +
              escapeHtml(m.created_at) + "</td><td>" + blBadge + "</td><td>" + blBtn + "</td></tr>";
          }).join("") || "<tr><td colspan=\"5\" class=\"text-center text-muted\">회원이 없습니다.</td></tr>";
          tbody.querySelectorAll(".btn-block").forEach(btn => {
            btn.onclick = () => toggleBlacklist(btn.dataset.id, true);
          });
          tbody.querySelectorAll(".btn-unblock").forEach(btn => {
            btn.onclick = () => toggleBlacklist(btn.dataset.id, false);
          });
        } else {
          tbody.innerHTML = "<tr><td colspan=\"5\" class=\"text-center text-danger\">" +
            escapeHtml(json.error || "로드 실패") + "</td></tr>";
        }
      })
      .catch(err => {
        document.getElementById("membersBody").innerHTML =
          "<tr><td colspan=\"5\" class=\"text-center text-danger\">로드 실패</td></tr>";
      });
  }

  function toggleBlacklist(id, blacklist) {
    fetch("/api/admin/members/" + id + "/blacklist", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ blacklist: blacklist })
    })
      .then(r => r.json().then(j => ({ ok: r.ok, json: j })))
      .then(({ ok, json }) => {
        if (ok) loadMembers();
        else alert("오류: " + (json.error || "알 수 없음"));
      })
      .catch(err => alert("오류: " + err.message));
  }

  loadMembers();
</script>
{% endblock %}
