{% extends "base.html" %}
{% block title %}커뮤니티{% endblock %}
{% block content %}
  <h1 class="mb-4">커뮤니티</h1>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <span id="pageInfo" class="text-muted"></span>
    <div class="d-flex gap-2">
      <a href="/minesweeper" class="btn btn-outline-secondary">지뢰찾기</a>
      <a href="/write" class="btn btn-primary">글쓰기</a>
    </div>
  </div>

  <div class="table-wrap">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>번호</th>
          <th>제목</th>
          <th>작성자</th>
          <th>작성일자</th>
        </tr>
      </thead>
      <tbody id="postsBody"></tbody>
    </table>
  </div>

  <div id="pageIndicator" class="d-flex justify-content-center gap-1 flex-wrap my-3"></div>
{% endblock %}

{% block extra_js %}
  <script>
    const LIMIT = 15;
    let currentPage = 1;
    let totalCount = 0;

    function escapeHtml(s) {
      if (s == null) return "";
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function loadPage(page) {
      currentPage = page;
      fetch("/api/posts?page=" + page + "&limit=" + LIMIT, { credentials: "include" })
        .then(r => r.json())
        .then(data => {
          totalCount = data.total || 0;
          const posts = data.posts || [];
          const tbody = document.getElementById("postsBody");
          tbody.innerHTML = posts.map(p =>
            "<tr><td>" + p.number + "</td><td class=\"post-title\"><a href=\"/post/" + p.id + "\">" + escapeHtml(p.title) + "</a></td><td>" +
            escapeHtml(p.author) + "</td><td>" + escapeHtml(p.created_at) + "</td></tr>"
          ).join("") || "<tr><td colspan=\"4\" class=\"text-center text-muted\">게시글이 없습니다.</td></tr>";

          const totalPages = Math.max(1, Math.ceil(totalCount / LIMIT));
          const indicator = document.getElementById("pageIndicator");
          indicator.innerHTML = "";
          for (let i = 1; i <= totalPages; i++) {
            const a = document.createElement("a");
            a.href = "#";
            a.className = "btn btn-sm " + (i === page ? "btn-primary" : "btn-outline-secondary");
            a.textContent = i;
            a.onclick = e => { e.preventDefault(); loadPage(i); };
            indicator.appendChild(a);
          }
        })
        .catch(err => { document.getElementById("postsBody").innerHTML = "<tr><td colspan=\"4\" class=\"text-center text-danger\">로드 실패: " + escapeHtml(err.message) + "</td></tr>"; });
    }

    loadPage(1);
  </script>
{% endblock %}
