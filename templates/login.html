{% extends "base.html" %}
{% block title %}로그인 - 커뮤니티{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4">로그인</h1>

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastErrorBody">로그인에 실패했습니다.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <form id="loginForm" class="mw-400">
    <div class="mb-3">
      <label class="form-label">아이디</label>
      <input type="text" class="form-control" name="username" required autocomplete="username">
    </div>
    <div class="mb-3">
      <label class="form-label">비밀번호</label>
      <input type="password" class="form-control" name="password" required autocomplete="current-password">
    </div>
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">로그인</button>
      <a href="/register" class="btn btn-outline-secondary">회원가입</a>
    </div>
  </form>
</div>

<script>
  (function() {
    let toast = null;
    try {
      const el = document.getElementById("toastError");
      if (el && typeof bootstrap !== "undefined") toast = new bootstrap.Toast(el);
    } catch (_) {}

    function showError(msg) {
      const body = document.getElementById("toastErrorBody");
      if (toast && body) {
        body.textContent = msg;
        toast.show();
      } else {
        alert(msg);
      }
    }

    if (new URLSearchParams(location.search).get("blacklist") === "1") {
      showError("블랙리스트로 지정되어 로그인할 수 없습니다.");
    }

    const form = document.getElementById("loginForm");
    if (form) {
      form.addEventListener("submit", function(e) {
        e.preventDefault();
        e.stopPropagation();
        const fd = new FormData(this);
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = "로그인 중...";
        fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ username: fd.get("username"), password: fd.get("password") })
        })
          .then(function(r) {
            return r.text().then(function(t) {
              try {
                return { ok: r.ok, json: t ? JSON.parse(t) : {} };
              } catch (_) {
                return { ok: false, json: { error: "서버 오류" } };
              }
            });
          })
          .then(function(res) {
            if (res.ok) {
              window.location.href = "/";
            } else {
              showError(res.json.error || "로그인에 실패했습니다.");
              btn.disabled = false;
              btn.textContent = "로그인";
            }
          })
          .catch(function(err) {
            showError("오류: " + (err.message || "알 수 없음"));
            btn.disabled = false;
            btn.textContent = "로그인";
          });
        return false;
      });
    }
  })();
</script>
{% endblock %}
