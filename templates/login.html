{% extends "base.html" %}
{% block title %}로그인 - 커뮤니티{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4">로그인</h1>

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastBlacklist" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">블랙리스트로 지정되어 로그인할 수 없습니다.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <form id="loginForm" class="mw-400">
    <div class="mb-3">
      <label class="form-label">아이디</label>
      <input type="text" class="form-control" name="username" required autocomplete="username">
    </div>
    <div class="mb-3">
      <label class="form-label">비밀번호</label>
      <input type="password" class="form-control" name="password" required autocomplete="current-password">
    </div>
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">로그인</button>
      <a href="/register" class="btn btn-outline-secondary">회원가입</a>
    </div>
  </form>
</div>

<script>
  const toastEl = document.getElementById("toastBlacklist");
  const toast = toastEl ? new bootstrap.Toast(toastEl) : null;

  function showBlacklistToast() {
    if (toast) toast.show();
  }

  if (new URLSearchParams(location.search).get("blacklist") === "1") {
    showBlacklistToast();
  }

  document.getElementById("loginForm").onsubmit = function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        username: fd.get("username"),
        password: fd.get("password")
      })
    })
      .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, json: j })))
      .then(({ ok, status, json }) => {
        if (ok) {
          location.href = "/";
        } else if (status === 403 && json.error && json.error.includes("블랙리스트")) {
          showBlacklistToast();
          btn.disabled = false;
        } else {
          alert("오류: " + (json.error || "알 수 없음"));
          btn.disabled = false;
        }
      })
      .catch(err => { alert("오류: " + err.message); btn.disabled = false; });
  };
</script>
{% endblock %}
