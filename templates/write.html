{% extends "base.html" %}
{% block title %}글쓰기 - 커뮤니티{% endblock %}
{% block content %}
  <h1 class="mb-4">글쓰기</h1>

  <form id="writeForm">
    <div class="mb-3" id="authorRow">
      <label class="form-label">작성자</label>
      {% if current_user %}
      <input type="text" class="form-control" name="author" value="{{ current_user }}" readonly>
      {% else %}
      <input type="text" class="form-control" name="author" required>
      {% endif %}
    </div>
    <div class="mb-3" id="passwordRow" {% if current_user %}style="display:none"{% endif %}>
      <label class="form-label">비밀번호</label>
      <input type="password" class="form-control" name="password" {% if not current_user %}required{% endif %}>
    </div>
    <div class="mb-3">
      <label class="form-label">제목</label>
      <input type="text" class="form-control" name="title" required>
    </div>
    <div class="mb-3">
      <label class="form-label">본문내용</label>
      <textarea class="form-control" name="content" rows="8"></textarea>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2 btn-group-mobile">
      <button type="submit" class="btn btn-primary">글작성완료</button>
      <a href="/" class="btn btn-outline-secondary">취소</a>
    </div>
  </form>

  <script>
    const isLoggedIn = {{ "true" if current_user else "false" }};
    document.getElementById("writeForm").onsubmit = function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      const body = {
        title: fd.get("title"),
        content: fd.get("content") || ""
      };
      if (isLoggedIn) {
        body.author = fd.get("author");
      } else {
        body.author = fd.get("author");
        body.password = fd.get("password");
      }
      fetch("/api/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body)
      })
        .then(r => r.json().then(j => ({ ok: r.ok, json: j })))
        .then(({ ok, json }) => {
          if (ok) {
            alert("글 작성 완료");
            location.href = "/";
          } else {
            alert("오류: " + (json.error || "알 수 없음"));
            btn.disabled = false;
          }
        })
        .catch(err => { alert("오류: " + err.message); btn.disabled = false; });
    };
  </script>
{% endblock %}
